<script>
    let csrf_token = "{{ csrf_token }}";
    let screenWidth = window.innerWidth;
    let currentUserId;
    let currentUserRole = "{{ userRole }}";
    let selectedBookingDateId;
    let selectedEventInfo;
    let calendar;
    let polishDaysOfWeek = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];
    let polishMonths = ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"];
    let availableBookingData;
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            timeZone: 'Europe/Warsaw',
            headerToolbar: {
                {#left: 'multiMonthYear,dayGridMonth,timeGridWeek,timeGridDay',#}
                left: 'dayGridMonth,timeGridWeek,timeGridDay',
                center: 'title',
                right: 'prev,today,next'
            },
            buttonText: {
                today: 'dzisiaj',
                month:    'miesiąc',
                week:     'tydzień',
                day:      'dzisiaj',
            },
            footerToolbar: {
                start: '',
                center: '',
                end: 'prev,next'
            },
            slotLabelFormat: {hour: 'numeric', minute: '2-digit', hour12: false},
            {#events: '/allEvents',#}
            eventSources: [
                '/allAvailableBookingDates',
                '/allUnconfirmedReservations',
                '/allConfirmedReservations',
            ],
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },

            firstDay: 1,
            selectable: true,
            editable: true,
            {#contentHeight: 1500,#}
            aspectRatio: 2.5,
            expandRows: true,
            allDayText: 'czas',
            eventContent: function(arg) {
                //console.log(arg.event.title, arg.event.start, arg.event.end)
                const start = getDateDetails(arg.event.start, '.', 'YMD')
                const end = getDateDetails(arg.event.end, '.', 'YMD')
                if (start.dateWithoutTime === end.dateWithoutTime) {
                    if (arg.event.extendedProps.intervalTimeInt) {
                        return { {#html: '<div class="fc-title">' + start.time + " - " + end.time + '</div><div class="fc-title">' + arg.event.title + '</div>',#}
                            html: `<div class="fc-title">${start.time} - ${end.time}</div><div class="fc-title">${arg.event.title}</div><div class="fc-title">Czas wizyty: ${arg.event.extendedProps.intervalTimeString}</div>`,
                        };
                    } else {
                        return { {#html: '<div class="fc-title">' + start.time + " - " + end.time + '</div><div class="fc-title">' + arg.event.title + '</div>',#}
                            html: `<div class="fc-title">${start.time} - ${end.time}</div><div class="fc-title">${arg.event.title}</div>`,
                        };
                    }
                }
                else {
                    if (arg.event.extendedProps.intervalTimeInt) {
                        return {
                            html: `<div class="fc-title">Od: ${start.dateWithoutTime} ${start.dayOfTheWeek} ${start.time}</div><div class="fc-title">Do: ${end.dateWithoutTime} ${end.dayOfTheWeek} ${end.time}</div><div class="fc-title">${arg.event.title}</div><div class="fc-title">Czas wizyty: ${arg.event.extendedProps.intervalTimeString}</div>`,
                        };
                    } else {
                        return {
                            html: `<div class="fc-title">Od: ${start.dateWithoutTime} ${start.dayOfTheWeek} ${start.time}</div><div class="fc-title">Do: ${end.dateWithoutTime} ${end.dayOfTheWeek} ${end.time}</div><div class="fc-title">${arg.event.title}</div>`,
                        };
                    }
                }
            },
            views: {
                dayGridMonth: {
                    titleFormat: myMonthTitleFormat,
                    displayEventEnd: true,
                    dayHeaderContent: myMonthdayHeaderContent,
                    {% comment %}eventContent: function(arg) {
                        const start = getDateDetails(arg.event.start, '.', 'YMD')
                        const end = getDateDetails(arg.event.end, '.', 'YMD')
                        if (start.dateWithoutTime === end.dateWithoutTime) {
                            return {
                                {#html: '<div class="fc-title">' + start.time + " - " + end.time + '</div><div class="fc-title">' + arg.event.title + '</div>',#}
                                html: `<div class="fc-title">${start.time} - ${end.time}</div><div class="fc-title">${arg.event.title}</div>`,
                            };
                        }
                        else {
                            return {
                                html: `<div class="fc-title">Od: ${start.dateWithoutTime} ${start.dayOfTheWeek} ${start.time}</div><div class="fc-title">Do: ${end.dateWithoutTime} ${end.dayOfTheWeek} ${end.time}</div><div class="fc-title">${arg.event.title}</div>`,
                            };
                        }
                    },{% endcomment %}
                },
                timeGridWeek:{
                    titleFormat: myWeekTitleFormat,
                    dayHeaderContent: myWeekdayHeaderContent,
                },
                timeGridDay:{
                    titleFormat: myDayTitleFormat,
                    dayHeaderContent: myDaydayHeaderContent,
                },
            },
            {#dodawanie dostepnych terminow#}
            select: function (data){
                if (currentUserRole !== "client")
                {
                    let selectedView = calendar.view.type;
                    console.log("Wykonalo sie dodanie")
                    const startDateTime = new Date(data.startStr)
                    let startDateOnly = startDateTime.toISOString().split('T')[0];
                    let startTimeOnly = startDateTime.toLocaleTimeString().slice(0, 5);
                    const endDateTime = new Date(data.endStr)
                    if (selectedView === 'dayGridMonth') { endDateTime.setDate(endDateTime.getDate() - 1) }
                    let endDateOnly = endDateTime.toISOString().split('T')[0];
                    let endTimeOnly = endDateTime.toLocaleTimeString().slice(0, 5);
                    if (selectedView !== 'dayGridMonth'){
                        {#dotyczy widoku kalendarza widoku tygodniowego/dniowego gdzie uzupelnia od razu godzine startu i konca#}
                        $('#addAvailableBookingDateByCalendarModal [name="startTime"]').val(startTimeOnly);
                        $('#addAvailableBookingDateByCalendarModal [name="endTime"]').val(endTimeOnly);
                    } else {
                        {#$('#addAvailableBookingDateByCalendarModal [name="startTime"]').val('12:00');#}
                        {#$('#addAvailableBookingDateByCalendarModal [name="endTime"]').val('23:00');#}
                    }
                    $('#startStrField').val(startDateOnly);
                    $('#endStrField').val(endDateOnly);
                    $('#addAvailableBookingDateByCalendarModal').removeClass('hidden');
                    $('body').addClass('overflow-hidden');
                }
            },
            {#edycja/usuwanie dostepnych terminow#}
            eventClick: function (info) {
                if ("{{ request.user }}" === 'AnonymousUser') { return; }
                currentUserId = {{ request.user.id }}
                console.log("WYKONALO SIE klikniecie eventu");

                //console.log('Event' + info.event.title + ' ' + info.event.start + ' : ' + info.event.end, "ServiceProvider userId", info.event.extendedProps.serviceProviderId);
                let serviceProviderId = info.event.extendedProps.serviceProviderId;
                let serviceProviderNameAndSurname = info.event.extendedProps.serviceProviderNameAndSurname;
                let clientId = info.event.extendedProps.clientId;
                let clientNameAndSurname = info.event.extendedProps.clientNameAndSurname;
                let eventType = info.event.extendedProps.eventType;
                let intervalTimeInt = info.event.extendedProps.intervalTimeInt;
                let intervalTimeString = info.event.extendedProps.intervalTimeString;
                let breakBetweenIntervals = info.event.extendedProps.breakBetweenIntervals;
                availableBookingData = {
                    serviceProviderNameAndSurname: serviceProviderNameAndSurname,
                    serviceProviderId: serviceProviderId,
                    startAvailableBookingDate: info.event.start,
                    endAvailableBookingDate: info.event.end,
                    clientNameAndSurname: clientNameAndSurname,
                    clientId: clientId,
                    intervalTimeInt: intervalTimeInt,
                    intervalTimeString: intervalTimeString,
                    breakBetweenIntervals: breakBetweenIntervals
                };
                selectedBookingDateId = info.event.id
                selectedEventInfo = info

                if (eventType === 0 && (serviceProviderId === currentUserId || currentUserRole === "admin" || currentUserRole === "controller")){ //edycja/usuwanie dostępnego terminu
                    $('#deleteSelectedEvent').val(selectedBookingDateId)
                    $('#editSelectedEvent').val(selectedBookingDateId)
                    openModal('changeOptionsAvailableBookingDateModal', availableBookingData);
                }else if (eventType === 0 && currentUserRole === "client" && intervalTimeInt === null) { //proba rezerwacji
                    // calosc
                    $('#reserveEntireSelectedBookingDateId').val(selectedBookingDateId)
                    $('#reserveEntireSelectedBookingDateStart').val(info.event.start.toISOString())
                    $('#reserveEntireSelectedBookingDateEnd').val(info.event.end.toISOString())
                    // czesc
                    $('#reservePartSingleDaySelectedBookingDateId').val(selectedBookingDateId)
                    $('#reservePartMultipleDaysSelectedBookingDateId').val(selectedBookingDateId)
                    openModal('reservationOptionsModal', availableBookingData);
                } else if (eventType === 0 && currentUserRole === "client" && intervalTimeInt){
                    // dotepny termin z przedzialami
                    $('#reserveIntervalOfBookingDateId').val(selectedBookingDateId)
                    openModal('reserveIntervalOfBookingDateModal', availableBookingData);
                } else if (eventType === 1 && (serviceProviderId === currentUserId || currentUserRole === "admin" || currentUserRole === "controller")) {
                    $('#confirmOrRejectReservationId').val(info.event.id)
                    openModal('confirmOrRejectReservationModal', availableBookingData)
                } else if ((eventType === 1 || eventType === 2) && (serviceProviderId === currentUserId || clientId === currentUserId || currentUserRole === "admin" || currentUserRole === "controller")) {
                    console.log("USUN TO")
                    $('#deleteReservationId').val(selectedBookingDateId)
                    openModal('deleteReservationModal')
                } else{
                    console.log("Nie masz uprawnien, zeby to zrobic")
                }
                console.log(currentUserRole);
            }
        });
        calendar.render();
        {#filtrowanie#}
        $(document).ready(function() {
            var select2Instance = $('.js-example-basic-multiple').select2({
                width: '200px',  // Set initial width
                placeholder: "Filtruj usługodawców",
                allowClear: true,
            });
            $('.select2-search__field').css('height', '24px');
            function calculateTextLength(selectedOptions) {
                let totalLength = 0;
                selectedOptions.forEach(function(option) {
                    totalLength += option.text.length;
                });
                return totalLength;
            };
            select2Instance.on('select2:select select2:unselect', function (e) {
                let selectedOptions = select2Instance.select2('data');
                {#console.log(selectedOptions, selectedOptions.length)#}
                let newWidth = calculateTextLength(selectedOptions) * 8 + 30 * selectedOptions.length + 100;
                {#console.log(newWidth)#}
                let newWidthMax = selectedOptions.length > 0 ? newWidth : '200';
                {#console.log(newWidthMax)#}
                newWidth = newWidthMax < screenWidth-350 ? newWidthMax+'px' : screenWidth-350+'px';
                {#console.log(newWidth)#}
                select2Instance.next('.select2-container').find('.select2-selection--multiple').css('width', newWidth);
            });
        });
    });
    function filter() {
        let selectedOptions = $('.js-example-basic-multiple').select2('data');
        console.log("Selected Options:", selectedOptions);
        $.ajax({
            type: 'POST',
            url: '/filterServiceProviders/',
            headers: {
                'X-CSRFToken': csrf_token
            },
            data: {
                'selectedOptions': JSON.stringify(selectedOptions)
            },
            success: function(response) {
                console.log(response);
                if ('error' in response) {
                    console.error("Error:", response.error)
                } else {
                    calendar.getEventSources().forEach(function(source) {
                        source.remove();
                    });
                    calendar.addEventSource(response.availableDates);
                    calendar.addEventSource(response.unconfirmedReservations);
                    calendar.addEventSource(response.confirmedReservations);
                }
            },
            error: function(error) {
                console.error("Error:", error.responseText);
            }
        });
    };
    function closeAddAvailableBookingDateByCalendarModal() {
        $('#addAvailableBookingDateByCalendarModal').addClass('hidden');
        $('body').removeClass('overflow-hidden');
    };
    function getDateDetails(date, dateSeparator = '-' , dateOrder = 'YMD'){
        //console.log("Data =", date)
        let time = date.toISOString().split('T')[1].slice(0, 5);
        const dateWithoutTimeZone = new Date(date.setMinutes(date.getMinutes() + date.getTimezoneOffset()))
        const day = dateWithoutTimeZone.getDate();
        const month = dateWithoutTimeZone.getMonth();
        const year = dateWithoutTimeZone.getFullYear();
        const dayOfTheWeek = polishDaysOfWeek[dateWithoutTimeZone.getDay()];
        const namedMonth = polishMonths[dateWithoutTimeZone.getMonth()];
        let dateWithoutTime = dateWithoutTimeZone.toISOString().split('T')[0];
        if (dateSeparator !== '-' || dateOrder !== 'YMD'){
            if (dateOrder === 'YMD'){
                dateWithoutTime = year + dateSeparator + month + dateSeparator + day;
            }
            if (dateOrder === 'DMY'){
                dateWithoutTime = day + dateSeparator + month + dateSeparator + year;
            }
        }
        return {dateWithoutTime, time, day, month, year, dayOfTheWeek, namedMonth};
    };
    function myMonthTitleFormat(date) {
        const startDate = new Date(date.start.marker);
        const endDate = new Date(date.end.marker);
        const start = getDateDetails(startDate, '.', 'YMD')
        const end = getDateDetails(endDate, '.', 'YMD')
        return start.namedMonth + " " + start.year
    };
    function myWeekTitleFormat(date) {
        const startDate = new Date(date.start.marker);
        const endDate = new Date(date.end.marker);
        const start = getDateDetails(startDate, '.', 'YMD')
        const end = getDateDetails(endDate, '.', 'YMD')
        return start.day + " " + start.namedMonth + " " + start.year + " - " + end.day + " " + end.namedMonth + " " + end.year
    };
    function myDayTitleFormat(date) {
        const startDate = new Date(date.start.marker);
        const endDate = new Date(date.end.marker);
        const start = getDateDetails(startDate, '.', 'YMD')
        const end = getDateDetails(endDate, '.', 'YMD')
        return start.day + " " + start.namedMonth + " " + start.year
    };
    function myMonthdayHeaderContent(date){
        return polishDaysOfWeek[date.date.getDay()];
    };
    function myWeekdayHeaderContent(date){
        return polishDaysOfWeek[date.date.getDay()]  + " " + date.date.getDate();
    };
    function myDaydayHeaderContent(date){
        {#return polishDaysOfWeek[date.date.getDay()]  + ", " + date.date.getDate() + " " + polishMonths[date.date.getMonth()] + " " + date.date.getFullYear();#}
        return polishDaysOfWeek[date.date.getDay()];
    };

    function fillCurrentTime(containerValue, inputValue) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const currentTime =  hours + ':' + minutes;
        $('#' + containerValue + ' .' + inputValue).val(currentTime);
    };
    function compareTime(time1, time2) {
        // Compare two time values in the format 'HH:mm'
        const [hours1, minutes1] = time1.split(':').map(Number);
        const [hours2, minutes2] = time2.split(':').map(Number);
        if (hours1 !== hours2) {
            return hours1 - hours2;
        }
        return minutes1 - minutes2;
    };
    function compareDate(date1, date2) {
        return date1.localeCompare(date2);
    }
    const setError = (element, message) => {
        console.log("Ser error work")
        const inputControl = element.parentElement.parentElement.parentElement;
        const errorDisplay = inputControl.querySelector('.error');
        errorDisplay.innerText = message;
        inputControl.classList.add('error');
        inputControl.classList.remove('success');
    };
    const setSuccess = element => {
        const inputControl = element.parentElement.parentElement.parentElement;
        const errorDisplay = inputControl.querySelector('.error');
        errorDisplay.innerText = "";
        inputControl.classList.add('success');
        inputControl.classList.remove('error');
    };
    function checkIfStartPlusIntervalsEqualEnd(startDateValue, startTimeValue, endDateValue, endTimeValue, interval, breakBetweenIntervals) {
        if (interval == "") { return true }
        const intervalTimeValue = parseInt(interval, 10);
        const breakBetweenIntervalsValue = parseInt(breakBetweenIntervals, 10);
        const totalMinutes = (intervalTimeValue + breakBetweenIntervalsValue);
        let validationCondition = false;
        let startDateHelp = new Date(startDateValue + ' ' + startTimeValue)
        let endDateHelp = new Date(endDateValue + ' ' + endTimeValue)
        //console.log(startDateValue, startTimeValue, startDateHelp, totalMinutes)
        while (startDateHelp < endDateHelp) {
            startDateHelp.setMinutes(startDateHelp.getMinutes() + totalMinutes);
            if (startDateHelp.getTime() === endDateHelp.getTime()) {
                //console.log("ROWNA SIE", startDateHelp, endDateHelp)
                validationCondition = true
            }
        }
        return validationCondition
    };
    {#Skrypt odpowiadajacy za walidacje czasow w dodawaniu wolnego terminu przez kalendarz#}
    const formAddAvailableBookingDateByCalendar = document.getElementById('addAvailableBookingDateByCalendarForm')
    const startTimeAddAvailableBookingDateByCalendar = document.getElementById('startTimeAddAvailableBookingDateByCalendarModal')
    const endTimeAddAvailableBookingDateByCalendar = document.getElementById('endTimeAddAvailableBookingDateByCalendarModal')
    const startDateAddAvailableBookingDateByCalendar = document.getElementById('startStrField')
    const endDateAddAvailableBookingDateByCalendar = document.getElementById('endStrField')
    const intervalTimeAddAvailableBookingDateByCalendar = document.getElementById('intervalTimeaddAvailableBookingDateByCalendarModal')
    const breakBetweenIntervalsAddAvailableBookingDateByCalendar = document.getElementById('breakBetweenIntervalsaddAvailableBookingDateByCalendarModal')
    formAddAvailableBookingDateByCalendar.addEventListener('submit', (e) => {
        const startTimeValue = startTimeAddAvailableBookingDateByCalendar.value;
        const endTimeValue = endTimeAddAvailableBookingDateByCalendar.value;
        //console.log(startTimeValue, endTimeValue)
        const startDateValue = startDateAddAvailableBookingDateByCalendar.value;
        const endDateValue = endDateAddAvailableBookingDateByCalendar.value;
        //console.log(startDateValue, endDateValue)
        if (compareDate(endDateValue, startDateValue) < 0){
            e.preventDefault();
            setError(startDateAddAvailableBookingDateByCalendar, "Data końcowa nie może być przed datą początku.")
            return;
        } else {
            setSuccess(startDateAddAvailableBookingDateByCalendar);
        }
        if (compareDate(endDateValue, startDateValue) === 0 && compareTime(endTimeValue, startTimeValue) <= 0) {
            e.preventDefault();
            setError(startTimeAddAvailableBookingDateByCalendar, "Czas końcowy nie może być przed czasem początku.")
            return;
        } else {
            setSuccess(startTimeAddAvailableBookingDateByCalendar);
        }
        //sprawdzenie czy start + n interwałów z przerwami = koniec
        if (checkIfStartPlusIntervalsEqualEnd(startDateValue, startTimeValue, endDateValue, endTimeValue, intervalTimeAddAvailableBookingDateByCalendar.value, breakBetweenIntervalsAddAvailableBookingDateByCalendar.value)) {
            setSuccess(endDateAddAvailableBookingDateByCalendar);
        } else {
            console.log("Zle przedzialy addCal: ", startDateValue, startTimeValue, endDateValue, endTimeValue, intervalTimeAddAvailableBookingDateByCalendar.value, breakBetweenIntervalsAddAvailableBookingDateByCalendar.value)
            e.preventDefault();
            setError(endDateAddAvailableBookingDateByCalendar, "Nieprawidłowy podział czasu.");
            return;
        }
    });
    {#Skrypt odpowiadajacy za walidacje dat i czasow w w dodawaniu wolnego terminu przez przycisk#}
    const formAddAvailableBookingDateModal = document.getElementById('addAvailableBookingDateForm')
    const startTimeAddAvailableBookingDateModal = document.getElementById('startTimeAddAvailableBookingDateModal')
    const endTimeAddAvailableBookingDateModal = document.getElementById('endTimeAddAvailableBookingDateModal')
    const startDateAddAvailableBookingDateModal = document.getElementById('startDateAddAvailableBookingDateModal')
    const endDateAddAvailableBookingDateModal = document.getElementById('endDateAddAvailableBookingDateModal')
    const intervalTimeAddAvailableBookingDateModal = document.getElementById('intervalTimeaddAvailableBookingDateModal')
    const breakBetweenIntervalsAddAvailableBookingDateModal = document.getElementById('breakBetweenIntervalsaddAvailableBookingDateModal')
    formAddAvailableBookingDateModal.addEventListener('submit', (e) => {
        console.log("WYKONALO SIE")
        const startTimeValue = startTimeAddAvailableBookingDateModal.value;
        const endTimeValue = endTimeAddAvailableBookingDateModal.value;
        const startDateValue = startDateAddAvailableBookingDateModal.value;
        const endDateValue = endDateAddAvailableBookingDateModal.value;
        if (compareDate(endDateValue, startDateValue) < 0){
            e.preventDefault();
            setError(startDateAddAvailableBookingDateModal, "Data końcowa nie może być przed datą początku.")
            return;
        } else {
            setSuccess(startDateAddAvailableBookingDateModal);
        }
        if (compareDate(endDateValue, startDateValue) === 0 && compareTime(endTimeValue, startTimeValue) <= 0) {
            e.preventDefault();
            setError(startTimeAddAvailableBookingDateModal, "Czas końcowy nie może być przed czasem początku.")
            return;
        } else {
            setSuccess(startTimeAddAvailableBookingDateModal);
        }

        //sprawdzenie czy start + n interwałów z przerwami = koniec
        if (checkIfStartPlusIntervalsEqualEnd(startDateValue, startTimeValue, endDateValue, endTimeValue, intervalTimeAddAvailableBookingDateModal.value, breakBetweenIntervalsAddAvailableBookingDateModal.value)) {
            setSuccess(endDateAddAvailableBookingDateModal);
        } else {
            console.log("Zle przedzialy addBtn: ", startDateValue, startTimeValue, endDateValue, endTimeValue, intervalTimeAddAvailableBookingDateModal.value, breakBetweenIntervalsAddAvailableBookingDateModal.value)
            e.preventDefault();
            setError(endDateAddAvailableBookingDateModal, "Nieprawidłowy podział czasu.");
            return;
        }
    });
    {#Skrypt odpowiadajacy za walidacje dat i czasow w w edytowaniu wolnego terminu#}
    const formEditAvailableBookingDateModal = document.getElementById('editAvailableBookingDateForm')
    const startTimeEditAvailableBookingDateModal = document.getElementById('startTimeEditAvailableBookingDateModal')
    const endTimeEditAvailableBookingDateModal = document.getElementById('endTimeEditAvailableBookingDateModal')
    const startDateEditAvailableBookingDateModal = document.getElementById('startDateEditAvailableBookingDateModal')
    const endDateEditAvailableBookingDateModal = document.getElementById('endDateEditAvailableBookingDateModal')
    const intervalTimeEditAvailableBookingDateModal = document.getElementById('intervalTimeeditAvailableBookingDateModal')
    const breakBetweenIntervalsEditAvailableBookingDateModal = document.getElementById('breakBetweenIntervalseditAvailableBookingDateModal')
    formEditAvailableBookingDateModal.addEventListener('submit', (e) => {
        console.log("WYKONALO SIE")
        const startTimeValue = startTimeEditAvailableBookingDateModal.value;
        const endTimeValue = endTimeEditAvailableBookingDateModal.value;
        const startDateValue = startDateEditAvailableBookingDateModal.value;
        const endDateValue = endDateEditAvailableBookingDateModal.value;
        if (compareDate(endDateValue, startDateValue) < 0){
            e.preventDefault();
            setError(startDateEditAvailableBookingDateModal, "Data końcowa nie może być przed datą początku.")
            return;
        } else {
            setSuccess(startDateEditAvailableBookingDateModal);
        }
        if (compareDate(endDateValue, startDateValue) === 0 && compareTime(endTimeValue, startTimeValue) <= 0) {
            console.error('edit3times End time cannot be earlier than start time or equal');
            e.preventDefault();
            setError(startTimeEditAvailableBookingDateModal, "Czas końcowy nie może być przed czasem początku.")
            return;
        } else {
            setSuccess(startTimeEditAvailableBookingDateModal);
        }
        //sprawdzenie czy start + n interwałów z przerwami = koniec
        if (checkIfStartPlusIntervalsEqualEnd(startDateValue, startTimeValue, endDateValue, endTimeValue, intervalTimeEditAvailableBookingDateModal.value, breakBetweenIntervalsEditAvailableBookingDateModal.value)) {
            setSuccess(endDateEditAvailableBookingDateModal);
        } else {
            console.log("Zle przedzialy addBtn: ", startDateValue, startTimeValue, endDateValue, endTimeValue, intervalTimeEditAvailableBookingDateModal.value, breakBetweenIntervalsEditAvailableBookingDateModal.value)
            e.preventDefault();
            setError(endDateEditAvailableBookingDateModal, "Nieprawidłowy podział czasu.");
            return;
        }
    });
    {#    Script to add/close new available booking date or used to changeOptions with data then#}
    function openModal(modalId, data) {
        let modal = document.getElementById(modalId);
        {#$('#'+modal).removeClass('hidden');#}
        if(data){
            openModalFillServiceProviderData(modal, data, modalId)
            if (data.clientId !== -1) {
                reserveOpenModalFillClientData(modal, data, modalId)
            }
            if (data.intervalTimeInt && modalId !== 'changeOptionsAvailableBookingDateModal') {
                reserveIntervalOpenModalFillInternalData(modal, data, modalId)
            }
            openModalFillDateTimeData(modal, data, modalId)
        }
        {#$('body').addClass('overflow-hidden');#}
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    };
    function openModalFillServiceProviderData(modal, data, modalId){
        let serviceProviderProfileElement = modal.querySelector('#serviceProviderProfileLink'+modalId);
        serviceProviderProfileElement.href = "/userProfile/"+data.serviceProviderId+"/";
        let serviceProviderNameAndSurnameElement = modal.querySelector('#serviceProviderNameAndSurname');
        serviceProviderNameAndSurnameElement.textContent = "Usługodawca: " + data.serviceProviderNameAndSurname;
    }
    function openModalFillDateTimeData(modal, data, modalId){
        let startDate = data.startAvailableBookingDate;
        let endDate = data.endAvailableBookingDate;
        {#uwzglednienie strefy czasowej#}
        startDate.setMinutes(startDate.getMinutes() + startDate.getTimezoneOffset())
        endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset())
        {#let startDateString = data.startAvailableBookingDate.toISOString().split('T')[0];#}
        let startDayOfTheWeek = polishDaysOfWeek[startDate.getDay()]
        let startDateString = startDate.getDate() + " " + polishMonths[startDate.getMonth()]
        let startTimeString = startDate.getMinutes() < 10 ? startDate.getHours() + ":0" + startDate.getMinutes() : startDate.getHours() + ":" + startDate.getMinutes();
        let endDateString = endDate.getDate() + " " + polishMonths[endDate.getMonth()]
        let endTimeString = endDate.getMinutes() < 10 ? endDate.getHours() + ":0" + endDate.getMinutes() : endDate.getHours() + ":" + endDate.getMinutes();
        let dateRangeAvailableBookingDateElement = modal.querySelector('#dateRangeAvailableBookingDate'+modalId);
        if (startDate.getDate() === endDate.getDate()){
            dateRangeAvailableBookingDateElement.textContent = startDayOfTheWeek + ", " + startDateString + " " + startTimeString + " - " + endTimeString
        }else{
            dateRangeAvailableBookingDateElement.textContent = startDateString + " " + startTimeString + " - " + endDateString + " " + endTimeString
        }
    };
    function reserveOpenModalFillClientData(modal, data, modalId) {
        let clientProfileElement = modal.querySelector('#clientProfileLink'+modalId);
        clientProfileElement.href = "/userProfile/"+data.clientId+"/";
        let clientNameAndSurnameElement = modal.querySelector('#clientNameAndSurname');
        clientNameAndSurnameElement.textContent = "Usługobiorca: " + data.clientNameAndSurname
    };
    // dotyczy reserveIntervalOfBookingDateModal
    function reserveIntervalOpenModalFillInternalData(modal, data, modalId) {
        let internalTimeElement = modal.querySelector('#internalTime'+modalId);
        console.log("InternalTimeElement =", internalTimeElement)
        internalTimeElement.textContent = "Czas wiztyty: " + data.intervalTimeString;
        let selectElement = modal.querySelector('#availableIntervalTimes'+modalId);
        selectElement.innerHTML = '<option value="" selected="">Dostępne terminy</option>';

        // Generate options based on available terms
        let startDateTerms = new Date(data.startAvailableBookingDate.setMinutes(data.startAvailableBookingDate.getMinutes() + data.startAvailableBookingDate.getTimezoneOffset()));
        let endDateTerms  = new Date(data.endAvailableBookingDate.setMinutes(data.endAvailableBookingDate.getMinutes() + data.endAvailableBookingDate.getTimezoneOffset()));
        let intervalTime = data.intervalTimeInt;
        let breakBetweenIntervals = data.breakBetweenIntervals

        while (startDateTerms < endDateTerms ) {
            let option = document.createElement('option');
            {#let startTimeStringValue = startDateTerms.toLocaleTimeString({ hour: 'numeric', minute: 'numeric' });#}
            {#let startDateStringValue = startDateTerms.toISOString().split('T')[0];#}
            option.value = `${startDateTerms.getDate()}/${startDateTerms.getMonth()+1}/${startDateTerms.getFullYear()} ${startDateTerms.toLocaleTimeString({ hour: 'numeric', minute: 'numeric' }).slice(0, 5)}`;
            option.text = `${startDateTerms.toLocaleTimeString({ hour: 'numeric', minute: 'numeric' }).slice(0, 5)}   ${polishDaysOfWeek[startDateTerms.getDay()]}, ${startDateTerms.getDate()} ${polishMonths[startDateTerms.getMonth()]}`
            if (startDateTerms.getMinutes() + intervalTime + breakBetweenIntervals < endDateTerms) {
                selectElement.appendChild(option);
            }
            // Increment the startDate by the intervalTime minutes
            startDateTerms.setMinutes(startDateTerms.getMinutes() + intervalTime + breakBetweenIntervals);
        }
    };
    function closeModal(modalId) {
        {#$('#'+modal).addClass('hidden');#}
        {#$('body').removeClass('overflow-hidden');#}
        let modal = document.getElementById(modalId);
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    };
    function editAvailableBookingDate() {
        {#console.log(selectedEventInfo)#}
        console.log("DATETIME nieprzetworzone: ", selectedEventInfo.event.start)
        closeModal('changeOptionsAvailableBookingDateModal');
        $('#editAvailableBookingDateModal [name="title"]').val(selectedEventInfo.event.title);
        let startDate = selectedEventInfo.event.start.toISOString().split('T')[0];
        let startTime = selectedEventInfo.event.start.toISOString().split('T')[1].slice(0, 5);
        let endDate = selectedEventInfo.event.end.toISOString().split('T')[0];
        let endTime = selectedEventInfo.event.end.toISOString().split('T')[1].slice(0, 5);
        console.log(startDate, startTime, endDate, endTime)
        $('#editAvailableBookingDateModal [name="startDate"]').val(startDate);
        $('#editAvailableBookingDateModal [name="startTime"]').val(startTime);
        $('#editAvailableBookingDateModal [name="endDate"]').val(endDate);
        $('#editAvailableBookingDateModal [name="endTime"]').val(endTime);
        $('#editAvailableBookingDateModal [name="intervalTime"]').val(selectedEventInfo.event.extendedProps.intervalTimeInt);
        $('#editAvailableBookingDateModal [name="breakBetweenIntervals"]').val(selectedEventInfo.event.extendedProps.breakBetweenIntervals);

        openModal('editAvailableBookingDateModal')
    };
    function openDeleteAvailableBookingDateModal() {
        closeModal('changeOptionsAvailableBookingDateModal');
        openModal('deleteAvailableBookingDateModal');
    };
    function openReservePartBookingDateModal() {
        closeModal('reservationOptionsModal');

        let startDate = selectedEventInfo.event.start.toISOString().split('T')[0];
        let startTime = selectedEventInfo.event.start.toISOString().split('T')[1].slice(0, 5);
        let endDate = selectedEventInfo.event.end.toISOString().split('T')[0];
        let endTime = selectedEventInfo.event.end.toISOString().split('T')[1].slice(0, 5);

        if (availableBookingData.startAvailableBookingDate.getDate() === availableBookingData.endAvailableBookingDate.getDate()) {
            $('#reservePartSingleDayBookingDateModal [name="startTime"]').val(startTime);
            $('#reservePartSingleDayBookingDateModal [name="endTime"]').val(endTime);
            openModal('reservePartSingleDayBookingDateModal');
        } else {
            $('#reservePartMultipleDaysBookingDateModal [name="startTime"]').val(startTime);
            $('#reservePartMultipleDaysBookingDateModal [name="endTime"]').val(endTime);
            $('#reservePartMultipleDaysBookingDateModal [name="startDate"]').val(startDate);
            $('#reservePartMultipleDaysBookingDateModal [name="endDate"]').val(endDate);
            openModal('reservePartMultipleDaysBookingDateModal');
        }
    };
    {#Skrypt odpowiadajacy za walidacje czasow przy rezerwacji terminu skladajacego sie z pojedynczego dnia#}
    const formReservePartSingleDayBookingDateModal = document.getElementById('reservePartSingleDayBookingDateForm')
    const startTimeReservePartSingleDayBookingDateModal = document.getElementById('startTimeReservePartSingleDayBookingDateModal')
    const endTimeReservePartSingleDayBookingDateModal = document.getElementById('endTimeReservePartSingleDayBookingDateModal')
    formReservePartSingleDayBookingDateModal.addEventListener('submit', (e) => {
        console.log("WYKONALa SIE walidacja")
        const startTimeValue = startTimeReservePartSingleDayBookingDateModal.value;
        const endTimeValue = endTimeReservePartSingleDayBookingDateModal.value;
        const availableBookingStartTimeString = availableBookingData.startAvailableBookingDate.getHours() + ':' + availableBookingData.startAvailableBookingDate.getMinutes();
        const availableBookingEndTimeString = availableBookingData.endAvailableBookingDate.getHours() + ':' + availableBookingData.endAvailableBookingDate.getMinutes();
        if (compareTime(endTimeValue, startTimeValue) <= 0) {
            console.error('End time cannot be earlier than start time or equal');
            e.preventDefault();
            setError(startTimeReservePartSingleDayBookingDateModal, "Czas końcowy nie może być przed czasem początku.")
        } else if (compareTime(startTimeValue, availableBookingStartTimeString) < 0 || compareTime(availableBookingEndTimeString, endTimeValue) < 0){
            console.error('Czas rezerwacji nie moze przekraczac czasu dostepnego terminu');
            e.preventDefault();
            setError(startTimeReservePartSingleDayBookingDateModal, "Czas wykracza poza czas dotępnego terminu.")
        } else {
            setSuccess(startTimeReservePartSingleDayBookingDateModal);
        }
    });
    {#Skrypt odpowiadajacy za walidacje czasow i dat przy rezerwacji terminu skladajacego sie z kilku dni#}
    const formReservePartMultipleDaysBookingDateModal = document.getElementById('reservePartMultipleDaysBookingDateForm')
    const startTimeReservePartMultipleDaysBookingDateModal = document.getElementById('startTimeReservePartMultipleDaysBookingDateModal')
    const endTimeReservePartMultipleDaysBookingDateModal = document.getElementById('endTimeReservePartMultipleDaysBookingDateModal')
    const startDateReservePartMultipleDaysBookingDateModal = document.getElementById('startDateReservePartMultipleDaysBookingDateModal')
    const endDateReservePartMultipleDaysBookingDateModal = document.getElementById('endDateReservePartMultipleDaysBookingDateModal')
    formReservePartMultipleDaysBookingDateModal.addEventListener('submit', (e) => {
        console.log("WYKONALa SIE walidacja")
        const startTimeValue = startTimeReservePartMultipleDaysBookingDateModal.value;
        const endTimeValue = endTimeReservePartMultipleDaysBookingDateModal.value;
        const startDateValue = startDateReservePartMultipleDaysBookingDateModal.value;
        const endDateValue = endDateReservePartMultipleDaysBookingDateModal.value;
        const availableBookingStartTimeString = availableBookingData.startAvailableBookingDate.getHours() + ':' + availableBookingData.startAvailableBookingDate.getMinutes();
        const availableBookingEndTimeString = availableBookingData.endAvailableBookingDate.getHours() + ':' + availableBookingData.endAvailableBookingDate.getMinutes();

        console.log("Test")
        console.log(startDateValue)
        console.log(availableBookingData.startAvailableBookingDate.getDate())

        if (compareDate(endDateValue, startDateValue) < 0){
            e.preventDefault();
            setError(startDateReservePartMultipleDaysBookingDateModal, "Data końcowa nie może być przed datą początku.")
            return;
        } else if (compareDate(startDateValue, availableBookingData.startAvailableBookingDate.toISOString().split('T')[0]) < 0 || compareDate(availableBookingData.endAvailableBookingDate.toISOString().split('T')[0], endDateValue) < 0){
            console.error('Data rezerwacji nie moze przekraczac daty dostepnego terminu');
            e.preventDefault();
            setError(startTimeReservePartMultipleDaysBookingDateModal, "Data wykracza poza date dotępnego terminu.")
            return;
        } else {
            setSuccess(startDateReservePartMultipleDaysBookingDateModal);
        }

        if (compareDate(endDateValue, startDateValue) === 0 && compareTime(endTimeValue, startTimeValue) <= 0) {
            console.error('End time cannot be earlier than start time or equal');
            e.preventDefault();
            setError(startTimeReservePartMultipleDaysBookingDateModal, "Czas końcowy nie może być przed czasem początku.")
        } else if (compareTime(startTimeValue, availableBookingStartTimeString) < 0 || compareTime(availableBookingEndTimeString, endTimeValue) < 0){
            console.error('Czas rezerwacji nie moze przekraczac czasu dostepnego terminu');
            e.preventDefault();
            setError(startTimeReservePartMultipleDaysBookingDateModal, "Czas wykracza poza czas dotępnego terminu.")
        } else {
            setSuccess(startTimeReservePartMultipleDaysBookingDateModal);
        }
    });
</script>