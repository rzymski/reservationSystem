{% extends 'base.html' %}

{% block content %}
    <div>
        <head>
            <title>Calendar</title>
{#            link do jQuery#}
            <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
{#            Kalendarz z https://fullcalendar.io/docs/initialize-globals #}
            <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
{#            alternatywna wersja z https://cdnjs.com/libraries/fullcalendar/6.1.9 chyba dziala tak samo #}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.min.js" integrity="sha512-xCMh+IX6X2jqIgak2DBvsP6DNPne/t52lMbAUJSjr3+trFn14zlaryZlBcXbHKw8SbrpS0n3zlqSVmZPITRDSQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.global.js" integrity="sha512-lU5sd0e7f59Jia30P5oEI5zC3BzVJ4ao+xRA70IIJ2UBzek4PCkPk+MTLIYwXTXGErOqjJ/rLdB3gLK0E5hD0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.global.min.js" integrity="sha512-XcSx5820pzZbdZYdvoBBKzuOivQv7oQMd+7JuUHh0jhMwqsWHOf+yRfZRxCtV0ySEKWtKblijTdl9pvODcmD7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.js" integrity="sha512-bBl4oHIOeYj6jgOLtaYQO99mCTSIb1HD0ImeXHZKqxDNC7UPWTywN2OQRp+uGi0kLurzgaA3fm4PX6e2Lnz9jQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            Datepicker tailwind#}
            <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/datepicker.min.js"></script>

            <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

            {% load static %}
            <link rel="stylesheet" type="text/css" href="{% static 'myCSS/calendar.css' %}">
        </head>
        <body>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: left; vertical-align: center; display: flex; align-items: center;">
                    <button id="filterButton" onclick="filter()" class="my-2 ml-2 mr-1 py-1 px-1 text-2xl font-semibold text-gray-900 focus:outline-none bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">Filtruj</button>
                    <select class="js-example-basic-multiple" name="serviceProviders[]" multiple="multiple">
                        {% for user in serviceProviders %}
                            <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% if userRole != 'normalUser' %}
                    <div style="text-align: right; vertical-align: center">
                        <button id="btnAddAvailableBookingDate" onclick="openModal('addAvailableBookingDateModal')" type="button" class="m-2 py-1 px-1 text-2xl font-semibold text-gray-900 focus:outline-none bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">Dodaj dostepny termin</button>
{#                        <button id="btnAddAvailableBookingDate" onclick="openModal('addAvailableBookingDateModal')" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-bold rounded-lg text-lg px-2.5 py-2.5 me-2 mb-2 dark:bg-gray-900 dark:hover:bg-gray-800 dark:focus:ring-gray-700 dark:border-gray-700">Dodaj dostepny termin</button>#}
                    </div>
                {% endif %}
            </div>
            {% if userRole != 'normalUser' %}
                {% include 'availableBookingDate/addAvailableBookingDateByCalendar.html' %}
                {% include 'availableBookingDate/addAvailableBookingDate.html' %}
                {% include 'availableBookingDate/editAvailableBookingDate.html' %}
                {% include 'availableBookingDate/deleteAvailableBookingDate.html' %}
                {% include 'availableBookingDate/changeOptionsAvailableBookingDate.html' %}
            {% endif %}
            <div class="col-md-12">
                <div id='calendar' class="dark:text-white bg-gray-100 dark:bg-gray-600"></div>
            </div>
        </body>
    </div>

    <script>
        var csrf_token = "{{ csrf_token }}";
        var screenWidth = window.innerWidth;
        var currentUserId;
        var currentUserRole = "{{ userRole }}";
        var selectedEventId;
        var selectedEventInfo;
        var calendar;
        var polishDaysOfWeek = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];
        var polishMonths = ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"];
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                timeZone: 'Europe/Warsaw',
                headerToolbar: {
                    {#left: 'multiMonthYear,dayGridMonth,timeGridWeek,timeGridDay',#}
                    left: 'dayGridMonth,timeGridWeek,timeGridDay',
                    center: 'title',
                    right: 'prev,today,next'
                },
                buttonText: {
                    today: 'dzisiaj',
                    month:    'miesiąc',
                    week:     'tydzień',
                    day:      'dzisiaj',
                },
                footerToolbar: {
                    start: '',
                    center: '',
                    end: 'prev,next'
                },
                slotLabelFormat: {hour: 'numeric', minute: '2-digit', hour12: false},
                {#events: '/allEvents',#}
                eventSources: [
                    '/allEvents',
                ],
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                firstDay: 1,
                selectable: true,
                editable: true,
                {#contentHeight: 1500,#}
                aspectRatio: 3,
                expandRows: true,
                allDayText: 'czas',
                views: {
                    dayGridMonth: {
                        titleFormat: myMonthTitleFormat,
                        displayEventEnd: true,
                        dayHeaderContent: myMonthdayHeaderContent,
                    },
                    timeGridWeek:{
                        titleFormat: myWeekTitleFormat,
                        dayHeaderContent: myWeekdayHeaderContent,
                    },
                    timeGridDay:{
                        titleFormat: myDayTitleFormat,
                        dayHeaderContent: myDaydayHeaderContent,
                    },
                },
                {#dodawanie dostepnych terminow#}
                select: function (data){
                    if (currentUserRole !== "normalUser")
                    {
                        console.log("Wykonalo sie dodanie")
                        console.log("D =", data)
                        console.log(data.startStr)
                        const startDateTime = new Date(data.startStr)
                        let startDateOnly = startDateTime.toISOString().split('T')[0];
                        let startTimeOnly = startDateTime.toLocaleTimeString().slice(0, 5);
                        const endDateTime = new Date(data.endStr)
                        let endTimeOnly = endDateTime.toLocaleTimeString().slice(0, 5);
                        console.log("CZAS =", startTimeOnly)
                        if (startTimeOnly != "01:00" || endTimeOnly != "01:00"){
                            $('#addAvailableBookingDateByCalendarModal [name="startTime"]').val(startTimeOnly);
                        }
                        $('#startStrField').val(startDateOnly);
                        $('#addAvailableBookingDateByCalendarModal').removeClass('hidden');
                        $('body').addClass('overflow-hidden');
                    }
                },
                {#edycja/usuwanie dostepnych terminow#}
                eventClick: function (info) {
                    if ("{{ request.user }}" === 'AnonymousUser') { return; }
                    currentUserId = {{ request.user.id }}
                    console.log("WYKONALO SIE klikniecie eventu");
                    //console.log('Event' + info.event.title + ' ' + info.event.start + ' : ' + info.event.end, "ServiceProvider userId", info.event.extendedProps.serviceProviderId);
                    let serviceProviderId = info.event.extendedProps.serviceProviderId;
                    if (serviceProviderId === currentUserId || currentUserRole === "admin" || currentUserRole === "controller"){
                        selectedEventId = info.event.id
                        selectedEventInfo = info
                        $('#deleteSelectedEvent').val(selectedEventId)
                        $('#editSelectedEvent').val(selectedEventId)
                        var availableBookindData = {
                            serviceProviderNameAndSurname: info.event.title,
                            serviceProviderId: serviceProviderId,
                            startAvailableBookingDate: info.event.start,
                            endAvailableBookingDate: info.event.end,
                        };
                        openModal('changeOptionsAvailableBookingDateModal', availableBookindData);
                    }else{
                        console.log("Nie masz uprawnien, zeby to zrobic")
                    }
                }
            });
            calendar.render();
            {#filtrowanie#}
            $(document).ready(function() {
                var select2Instance = $('.js-example-basic-multiple').select2({
                    width: '200px',  // Set initial width
                    placeholder: "Filtruj usługodawców",
                    allowClear: true,
                });
                $('.select2-search__field').css('height', '24px');
                function calculateTextLength(selectedOptions) {
                    let totalLength = 0;
                    selectedOptions.forEach(function(option) {
                        totalLength += option.text.length;
                    });
                    return totalLength;
                };
                select2Instance.on('select2:select select2:unselect', function (e) {
                    let selectedOptions = select2Instance.select2('data');
                    {#console.log(selectedOptions, selectedOptions.length)#}
                    let newWidth = calculateTextLength(selectedOptions) * 8 + 30 * selectedOptions.length + 100;
                    {#console.log(newWidth)#}
                    let newWidthMax = selectedOptions.length > 0 ? newWidth : '200';
                    {#console.log(newWidthMax)#}
                    newWidth = newWidthMax < screenWidth-350 ? newWidthMax+'px' : screenWidth-350+'px';
                    {#console.log(newWidth)#}
                    select2Instance.next('.select2-container').find('.select2-selection--multiple').css('width', newWidth);
                });
            });
        });
        function filter() {
            let selectedOptions = $('.js-example-basic-multiple').select2('data');
            console.log("Selected Options:", selectedOptions);
            $.ajax({
                type: 'POST',
                url: '/filterServiceProviders/',
                headers: {
                    'X-CSRFToken': csrf_token
                },
                data: {
                    'selected_options': JSON.stringify(selectedOptions)
                },
                success: function(response) {
                    console.log("POWINNO DZIALAC")
                    console.log(response);
                    {#calendar.refetchEvents();#}
                    calendar.getEventSources().forEach(function(source) {
                        source.remove();
                    });
                    calendar.addEventSource(response)
                }
            });
        };
        function closeAddAvailableBookingDateByCalendarModal() {
            $('#addAvailableBookingDateByCalendarModal').addClass('hidden');
            $('body').removeClass('overflow-hidden');
        };



        function myMonthTitleFormat(date) {
            const startDate = new Date(date.start.marker);
            const endDate = new Date(date.end.marker);
            const startDay = startDate.getDate();
            const startMonth = startDate.getMonth();
            const startYear = startDate.getFullYear();
            const endDay = endDate.getDate();
            const endMonth = endDate.getMonth();
            const endYear = endDate.getFullYear();
            return polishMonths[startMonth] + " " + startYear;
        };
        function myWeekTitleFormat(date) {
            const startDate = new Date(date.start.marker);
            const endDate = new Date(date.end.marker);
            const startDay = startDate.getDate();
            const startMonth = startDate.getMonth();
            const startYear = startDate.getFullYear();
            const endDay = endDate.getDate();
            const endMonth = endDate.getMonth();
            const endYear = endDate.getFullYear();
            const dateRangeString = startDay + " " + polishMonths[startMonth] + " " + startYear + " - " + endDay + " " + polishMonths[endMonth] + " " + endYear
            return dateRangeString;
        };
        function myDayTitleFormat(date) {
            const startDate = new Date(date.start.marker);
            const startDay = startDate.getDate();
            const startMonth = startDate.getMonth();
            const startYear = startDate.getFullYear();
            const dateRangeString = startDay + " " + polishMonths[startMonth] + " " + startYear
            return dateRangeString;
        };

        function myMonthdayHeaderContent(date){
            return polishDaysOfWeek[date.date.getDay()];
        };

        function myWeekdayHeaderContent(date){
            return polishDaysOfWeek[date.date.getDay()]  + " " + date.date.getDate();
        };

        function myDaydayHeaderContent(date){
            {#return polishDaysOfWeek[date.date.getDay()]  + ", " + date.date.getDate() + " " + polishMonths[date.date.getMonth()] + " " + date.date.getFullYear();#}
            return polishDaysOfWeek[date.date.getDay()];
        };
    </script>
{% endblock %}