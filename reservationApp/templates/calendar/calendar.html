{% extends 'base.html' %}

{% block content %}
    <div>
        <head>
            <title>Calendar</title>
{#            wlasny CSS kolidowal z naglowkiem#}
{#            <link rel="stylesheet" type="text/css" href="{% static 'myCSS/calendar.css' %}">#}
{#            link do jQuery#}
            <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
{#            Kalendarz z https://fullcalendar.io/docs/initialize-globals #}
            <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
{#            alternatywna wersja z https://cdnjs.com/libraries/fullcalendar/6.1.9 chyba dziala tak samo #}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.min.js" integrity="sha512-xCMh+IX6X2jqIgak2DBvsP6DNPne/t52lMbAUJSjr3+trFn14zlaryZlBcXbHKw8SbrpS0n3zlqSVmZPITRDSQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.global.js" integrity="sha512-lU5sd0e7f59Jia30P5oEI5zC3BzVJ4ao+xRA70IIJ2UBzek4PCkPk+MTLIYwXTXGErOqjJ/rLdB3gLK0E5hD0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.global.min.js" integrity="sha512-XcSx5820pzZbdZYdvoBBKzuOivQv7oQMd+7JuUHh0jhMwqsWHOf+yRfZRxCtV0ySEKWtKblijTdl9pvODcmD7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.js" integrity="sha512-bBl4oHIOeYj6jgOLtaYQO99mCTSIb1HD0ImeXHZKqxDNC7UPWTywN2OQRp+uGi0kLurzgaA3fm4PX6e2Lnz9jQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>#}
{#            Datepicker tailwind#}
            <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/datepicker.min.js"></script>
        </head>
        <body>
            <div style="display: flex; justify-content: space-between">
                <div style="text-align: left">
{#                    <label for="users" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Wybierz usługodawcę:</label>#}
                    <select id="users" class="w-48 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                      <option selected>Filtruj usługodawcę:</option>
                      {% for user in serviceProviders %}
                          <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}</option>
                      {% endfor %}
                    </select>
                </div>
                <div style="text-align: right">
                    <button id="btnAddAvailableBookingDate" onclick="openModal('addAvailableBookingDateModal')" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-bold rounded-lg text-lg px-2.5 py-2.5 me-2 mb-2 dark:bg-gray-900 dark:hover:bg-gray-800 dark:focus:ring-gray-700 dark:border-gray-700">Dodaj dostepny termin</button>
                </div>
            </div>
            {% include 'availableBookingDate/addAvailableBookingDateByCalendar.html' %}
            {% include 'availableBookingDate/addAvailableBookingDate.html' %}
            {% include 'availableBookingDate/editAvailableBookingDate.html' %}
            {% include 'availableBookingDate/deleteAvailableBookingDate.html' %}
            {% include 'availableBookingDate/changeOptionsAvailableBookingDate.html' %}
            <div class="col-md-12">
                <div id='calendar' class="dark:text-white bg-gray-100 dark:bg-gray-600"></div>
            </div>
        </body>
    </div>

    <script>
        var selectedEventId;
        var selectedEventInfo;
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                timeZone: 'Europe/Warsaw',
                headerToolbar: {
                    left: 'multiMonthYear,dayGridMonth,timeGridWeek,timeGridDay',
                    center: 'title',
                    right: 'prevYear,prev,today,next,nextYear'
                },
                footerToolbar: {
                    start: '',
                    center: '',
                    end: 'prev,next'
                },

                slotLabelFormat: {hour: 'numeric', minute: '2-digit', hour12: false},

                events: '/allEvents',

                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },

                selectable: true,
                editable: true,

                {#contentHeight: 1500,#}
                {#aspectRatio: 2,#}
                {#expandRows: true,#}

                views: {
                    dayGridMonth: {
                        titleFormat: myMonthTitleFormat,
                        displayEventEnd: true,
                    },
                    timeGridWeek:{
                        titleFormat: myWeekTitleFormat,
                    },
                    timeGridDay:{
                        titleFormat: myDayTitleFormat,
                    },
                },

                select: function (data){
                    console.log("Wykonalo sie dodanie")
                    console.log("D =", data)
                    console.log(data.startStr)
                    const startDateTime = new Date(data.startStr)
                    let startDateOnly = startDateTime.toISOString().split('T')[0];
                    let startTimeOnly = startDateTime.toLocaleTimeString().slice(0, 5);
                    const endDateTime = new Date(data.endStr)
                    let endTimeOnly = endDateTime.toLocaleTimeString().slice(0, 5);
                    console.log("CZAS =", startTimeOnly)
                    if (startTimeOnly != "01:00" || endTimeOnly != "01:00"){
                        $('#addAvailableBookingDateByCalendarModal [name="startTime"]').val(startTimeOnly);
                    }
                    $('#startStrField').val(startDateOnly);
                    $('#addAvailableBookingDateByCalendarModal').removeClass('hidden');
                    $('body').addClass('overflow-hidden');
                },

                eventClick: function (info) {
                    console.log(info)
                    console.log("WYKONALO SIE klikniecie eventu");
                    console.log('Event' + info.event.title + ' ' + info.event.start + ' : ' + info.event.end);
                    selectedEventId = info.event.id
                    selectedEventInfo = info
                    $('#deleteSelectedEvent').val(selectedEventId)
                    $('#editSelectedEvent').val(selectedEventId)
                    openModal('changeOptionsAvailableBookingDateModal');
                }
            });
            calendar.render();

            document.getElementById('users').addEventListener('change', function() {
                console.log("WYKONALO SIE: ", this.value)
                {#calendar.refetchEvents();#}

                {#calendar.setOption('events', '/allEvents');#}
                calendar.setOption('events', '/getEvents/' + this.value + '/');
            });
        });
        function closeAddAvailableBookingDateByCalendarModal() {
            $('#addAvailableBookingDateByCalendarModal').addClass('hidden');
            $('body').removeClass('overflow-hidden');
        };



        function myMonthTitleFormat(date) {
            const startDate = new Date(date.start.marker);
            const endDate = new Date(date.end.marker);
            const startDay = startDate.getDate();
            const startMonth = startDate.getMonth() + 1;
            const startYear = startDate.getFullYear();
            const endDay = endDate.getDate();
            const endMonth = endDate.getMonth() + 1;
            const endYear = endDate.getFullYear();
            const dateRangeString = startDay + "/" + startMonth + "/" + startYear + " - " + endDay + "/" + endMonth + "/" + endYear
            return dateRangeString;
        };
        function myWeekTitleFormat(date) {
            const startDate = new Date(date.start.marker);
            const endDate = new Date(date.end.marker);
            const startDay = startDate.getDate();
            const startMonth = startDate.getMonth() + 1;
            const startYear = startDate.getFullYear();
            const endDay = endDate.getDate();
            const endMonth = endDate.getMonth() + 1;
            const endYear = endDate.getFullYear();
            const dateRangeString = startDay + "/" + startMonth + "/" + startYear + " - " + endDay + "/" + endMonth + "/" + endYear
            return dateRangeString;
        };
        function myDayTitleFormat(date) {
            const startDate = new Date(date.start.marker);
            const startDay = startDate.getDate();
            const startMonth = startDate.getMonth() + 1;
            const startYear = startDate.getFullYear();
            const dateRangeString = startDay + "/" + startMonth + "/" + startYear
            return dateRangeString;
        };
    </script>
{% endblock %}